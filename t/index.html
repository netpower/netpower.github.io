<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Web AeTimeline</title>
    <!-- vconsole -->
    <script src="https://unpkg.com/vconsole/dist/vconsole.min.js"></script>
    <script type="text/javascript">
        new VConsole()
    </script>    
</head>

<body>
    <div>
        <h1>AeTimeline人脸检测和美颜</h1>
        <div>
            <!-- <button disabled id="initBtn" style="height:64px">初始化引擎</button>  -->
            <!-- <button disabled id="initFaceBtn" style="height:64px">初始化人脸检测</button>  -->
            <button disabled id="startCameraBtn" style="height:64px">打开摄像头</button>
            <button disabled id="switchCameraBtn" style="height:64px">切换摄像头</button>
            <input disabled id="beautyCheck" type="checkbox" checked="true">开启美颜</input> 
            <input disabled id="lipCheck" type="checkbox">开启美妆</input> 
            <input disabled id="stickerCheck" type="checkbox">开启贴纸</input> 
        </div>
        <div>
            <canvas id="canvas" class="video"></canvas>
        </div>
    </div>
    <script src="./AeTimeline.js"></script>    
    <script type='text/javascript'>
        window.addEventListener("wasmLoaded", () => {
            console.log("wasmLoaded")
            //initBtn.disabled = false;
            // initBtn.addEventListener("click", () => {
            //     Module._AEWebInit()
            //     initFaceBtn.disabled = false;
            // })

            // initFaceBtn.addEventListener("click", () => {
            //     res = Module._AEWebCreateFaceHandle()
            //     console.log(res)
            //     startCameraBtn.disabled = false;
            // })
            Module._AEWebInit();
            res = Module._AEWebCreateFaceHandle()
            console.log(res)
            startCameraBtn.disabled = false;
        });
        var shouldFaceUser = true;
        var stream = null;
        var faceImgBuffer = null;
        var faceImgBufferLength = 0;
        var faceRGBBuffer = null;
        var faceFrameBuffer = null;
        var texture = null;
        var mWidth  = 1280;
        var mHeight = 720;
        var textureId = null;
        var video = null;   //摄像头的视频源 HTMLVideoElement

        const gl = document.getElementById('canvas').getContext("webgl");
        // Only continue if WebGL is available and working
        if (gl === null) {
            alert("Unable to initialize WebGL. Your browser or machine may not support it.");
        }

        //https://github.com/emscripten-core/emscripten/issues/6103
        function RegisterNativeTextureId(textureResource)
        {
            var id = GL.getNewId(GL.textures); // already included in code generated by emscripten
            textureResource.name = id;
            GL.textures[id] = textureResource;

            return id;
        }

        function UnregisterNativeTextureId(nativeTextureId)
        {
            var tex = GL.textures[nativeTextureId];

            tex.name = 0;
            GL.textures[nativeTextureId] = null;

            return tex;
        }

        function render() {
            // https://www.chuyouxiang.com/archives/1014
            if (stream == null) {
                console.log('stream is null');
                requestAnimationFrame(render);
                return;
            }

            if (video == null) {
                console.log('video is null');
                return;
            }


            var canvasId  = 'canvas';
            var strBuffer = new TextEncoder().encode(canvasId);
            var strPointer = Module._malloc(strBuffer.length + 1);
            Module.HEAPU8.set(strBuffer, strPointer);
            Module.HEAPU8[strPointer + strBuffer.length] = 0;

            Module._AEWebMakeCurrent(strPointer);
            if (texture == null) {
                // Create texture
                texture = gl.createTexture();
                textureId = RegisterNativeTextureId(texture);

                gl.bindTexture(gl.TEXTURE_2D, texture);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);
                gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);
                // Initialize rendering
                gl.viewport(0, 0, gl.canvas.width, gl.canvas.height);
                gl.clearColor(0.0,0.0,0.0,1.0);
            }
            
            //console.log('texture:' + textureId);            
            gl.activeTexture(gl.TEXTURE0);
            gl.bindTexture(gl.TEXTURE_2D, texture);
            gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, video);

            //console.log('GL Error - 1: ' + gl.getError());
            detectFaceGL();
            //console.log('GL Error - 2: ' + gl.getError());
            Module._AERenderCameraImage(strPointer, textureId, !beautyCheck.checked);//
            //console.log('GL Error - 3: ' + gl.getError());
            Module._free(strPointer);
            requestAnimationFrame(render);
        }

        window.addEventListener('DOMContentLoaded', function() {            
            var isStreaming = false;
            switchcamerabtn = document.getElementById('switchCameraBtn');
            video = document.createElement("video");
            video.playsInline = true;
            video.muted = true;            

            canvas = document.getElementById('canvas');

            // Wait until the video stream canvas play
            video.addEventListener('canplay', function(e) {
                if (!isStreaming) {
                    // videoWidth isn't always set correctly in all browsers
                    // ？？？ comment out by now -->
                    //if (video.videoWidth > 0) mHeight = video.videoHeight / (video.videoWidth / mWidth);
                    // <---
                    if (video.videoWidth > 0 && video.videoHeight > 0) {
                        mWidth  = video.videoWidth;
                        mHeight = video.videoHeight;
                    }
                    canvas.setAttribute('width', mWidth);
                    canvas.setAttribute('height', mHeight);
                    console.log("video size is:"+ video.videoWidth + "x" + video.videoHeight);
                    console.log("set canvas size:"+ mWidth + "x" + mHeight);
                    isStreaming = true;
                }
            }, false);

            video.addEventListener('error', () => {
                console.error('Error loading: camera video');
                console.error(`Error ${video.error.code}; details: ${video.error.message}`);
            });

            video.addEventListener('abort', () => {
                console.log(`Abort loading: ${video}`);
            });

            video.addEventListener('ended', (event) => {
                console.log('Video stopped either because 1) it was over, ' +
                            'or 2) no further data is available.');
            });

            // check whether we can use facingMode
            var supports = navigator.mediaDevices.getSupportedConstraints();

            startCameraBtn.addEventListener("click", () => {
                Module._AEWebCreateBeautyEngine()
                capture();
                if (supports['facingMode'] === true) {
                    switchcamerabtn.disabled = false;
                } 
                beautyCheck.disabled = false;               
                lipCheck.disabled = false;
                stickerCheck.disabled = false;
            })

            beautyCheck.addEventListener("change", () => {
                lipCheck.disabled       = !beautyCheck.checked;
                stickerCheck.disabled   = !beautyCheck.checked;
            })

            lipCheck.addEventListener("change", () => {
                if (lipCheck.checked) {
                    console.log('开启');
                    Module._AEWebEnableMakeup(0, true);
                }else{
                    console.log('关闭');
                    Module._AEWebEnableMakeup(0, false);
                }
            })

            stickerCheck.addEventListener("change", () => {
                Module._AEWebTestSticker(stickerCheck.checked);
            })

            switchcamerabtn.addEventListener('click', function() {
                if (stream == null)
                    return

                stream.getTracks().forEach(t => {
                    t.stop();
                });

                shouldFaceUser = !shouldFaceUser;
                capture();
            });                    
        });
        function capture() {
            var constraints = { audio: false, video: { width: 1280, height: 720, facingMode: shouldFaceUser ? 'user' : 'environment' } };
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(mediaStream) {
                    stream = mediaStream;
                    video.srcObject = mediaStream;
                    //console.log(stream);
                    var videoW = stream.getVideoTracks()[0].getSettings().width;
                    var videoH = stream.getVideoTracks()[0].getSettings().height;
                    console.log("videoW:"+ videoW + " videoH:" + videoH);
                    video.onloadedmetadata = function(e) {
                        video.play();
                        render();
                    };
                })
                .catch(function(err) {
                    console.log(err.message);
                });
        }

        function detectFaceGL (){
            try {
                var canvas = document.getElementById('canvas');
                var imageSize = canvas.width * canvas.height * 4;
                if (faceImgBufferLength != imageSize) {
                    if (faceRGBBuffer != null) {
                        faceRGBBuffer = null;                        
                    }
                    if (faceImgBuffer != null) {
                        Module._free(faceImgBuffer);
                        faceImgBuffer = null;
                    }
                    faceImgBufferLength = imageSize;
                }
                if (faceRGBBuffer == null) {
                    faceRGBBuffer = new Uint8Array(faceImgBufferLength);                    
                }
                if (faceImgBuffer == null){
                    faceImgBuffer = Module._malloc(faceImgBufferLength);
                }

                if (texture == null) {
                    return;
                }
                const frameBuffer = gl.getParameter(gl.FRAMEBUFFER_BINDING);

                if (faceFrameBuffer == null) {
                    faceFrameBuffer = gl.createFramebuffer();    
                }                
                gl.bindFramebuffer( gl.FRAMEBUFFER, faceFrameBuffer );
                gl.framebufferTexture2D( gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0 );
                gl.readPixels(0, 0, gl.drawingBufferWidth, gl.drawingBufferHeight, gl.RGBA, gl.UNSIGNED_BYTE, faceRGBBuffer);

                //console.log(faceRGBBuffer);
                HEAPU8.set(faceRGBBuffer, faceImgBuffer);

                let count = Module._AEWebDetectFace(faceImgBuffer, canvas.width, canvas.height, 0, 0);
                gl.bindFramebuffer( gl.FRAMEBUFFER, frameBuffer);
                if (frameBuffer) {
                    gl.framebufferTexture2D( gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, null, 0 );    
                }
             } catch (e) {
               console.log(e);
             };            
        }

    </script>
</body>
</html>